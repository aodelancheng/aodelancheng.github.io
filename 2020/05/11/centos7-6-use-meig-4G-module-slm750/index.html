<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"alderaan.xyz",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="概述​    想要实现4G上网有两种方式，要么加多一个4G路由器，再通过优先接入；要么通过增加4G模块（可为USB或PCIE等多种接口），直接进行拨号上网。尝试在一款J1900工控机上（该工控机自带SIM插槽），通过增加PCIE接口的美格4G模块SLM750，进行拨号上网。Windows系统下已测试过，直接安装厂家提供驱动，可以正常上网，说明硬件方面是完全支持的。本文参照厂家提供的嵌入式方案，进行"><meta property="og:type" content="article"><meta property="og:title" content="Centos 7.6 下使用美格SLM750（4G模块）拨号上网"><meta property="og:url" content="https://alderaan.xyz/2020/05/11/centos7-6-use-meig-4G-module-slm750/index.html"><meta property="og:site_name" content="Alderaan的博客"><meta property="og:description" content="概述​    想要实现4G上网有两种方式，要么加多一个4G路由器，再通过优先接入；要么通过增加4G模块（可为USB或PCIE等多种接口），直接进行拨号上网。尝试在一款J1900工控机上（该工控机自带SIM插槽），通过增加PCIE接口的美格4G模块SLM750，进行拨号上网。Windows系统下已测试过，直接安装厂家提供驱动，可以正常上网，说明硬件方面是完全支持的。本文参照厂家提供的嵌入式方案，进行"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-05-11T09:40:13.000Z"><meta property="article:modified_time" content="2020-05-11T14:50:07.861Z"><meta property="article:author" content="Alderaan"><meta property="article:tag" content="Centos"><meta property="article:tag" content="4G moduleC"><meta property="article:tag" content="SLM750"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://alderaan.xyz/2020/05/11/centos7-6-use-meig-4G-module-slm750/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Centos 7.6 下使用美格SLM750（4G模块）拨号上网 | Alderaan的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Alderaan的博客" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Alderaan的博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://alderaan.xyz/2020/05/11/centos7-6-use-meig-4G-module-slm750/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Alderaan"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Alderaan的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Centos 7.6 下使用美格SLM750（4G模块）拨号上网</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-11 17:40:13 / 修改时间：22:50:07" itemprop="dateCreated datePublished" datetime="2020-05-11T17:40:13+08:00">2020-05-11</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Centos/" itemprop="url" rel="index"><span itemprop="name">Centos</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>​ 想要实现4G上网有两种方式，要么加多一个4G路由器，再通过优先接入；要么通过增加4G模块（可为USB或PCIE等多种接口），直接进行拨号上网。尝试在一款J1900工控机上（该工控机自带SIM插槽），通过增加PCIE接口的美格4G模块<code>SLM750</code>，进行拨号上网。Windows系统下已测试过，直接安装厂家提供驱动，可以正常上网，说明硬件方面是完全支持的。本文参照厂家提供的嵌入式方案，进行驱动编译安装，并编译拨号软件，最终实现工控机4G上网功能。</p><a id="more"></a><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>​ 系统为Cento 7.6 64bit，基本环境为Basic Web Server安装（理论上与安装环境模式无关，最小安装也可以）。需要下载内核源码，Centos 7.6的内核版本为<code>3.10.0-957</code>，源码可在此<a href="http://vault.centos.org/7.6.1810/updates/Source/SPackages/kernel-3.10.0-957.21.3.el7.src.rpm" target="_blank" rel="noopener">链接</a>下载。另外还需要厂家提供的<code>GobiNet</code>网卡拨号的驱动及拨号工具源码，一张能4G上网的手机卡或物联网卡，接好模块天线。</p><h2 id="编译内核源码"><a href="#编译内核源码" class="headerlink" title="编译内核源码"></a>编译内核源码</h2><p>​ 将下载好的源码，解压到看到<code>linux-3.10.0-957.21.3.el7.tar.xz</code>文件，将其放到<code>/usr/src/kernels</code>文件夹下，并执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvf linux-3.10.0-957.21.3.el7.tar.xz // 解压内核源码文件</span><br><span class="line">$ mv linux-3.10.0-957.21.3.el7 3.10.0-957.el7.x86_64 // 重命名文件夹</span><br></pre></td></tr></table></figure><p>​ 之所以要更改文件夹名称，是因为厂家的<code>GobiNet</code>驱动源码，<code>Makefile</code>文件中：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">obj-m := GobiNet.o</span><br><span class="line">GobiNet-objs := GobiUSBNet.o QMIDevice.o QMI.o</span><br><span class="line"></span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">OUTPUTDIR=/lib/modules/`uname -r`/kernel/drivers/net/usb/</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifeq ($(ARCH),)</span></span><br><span class="line"><span class="comment">#EARCH := $(shell uname -m)</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">#ifeq ($(CROSS_COMPILE),)</span></span><br><span class="line"><span class="comment">#CROSS_COMPILE :=</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">#ifeq ($(KDIR),)</span></span><br><span class="line">KDIR := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build <span class="comment"># 这里通过uname -r 获取了内核名称</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="section">default:</span></span><br><span class="line"><span class="comment">#	ln -sf makefile Makefile</span></span><br><span class="line">	<span class="comment">#$(MAKE) ARCH=$&#123;ARCH&#125; CROSS_COMPILE=$&#123;CROSS_COMPILE&#125; -C $(KDIR) M=$(PWD) modules</span></span><br><span class="line">	<span class="variable">$(MAKE)</span>  CROSS_COMPILE=$&#123;CROSS_COMPILE&#125; -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">install: default</span></span><br><span class="line">	mkdir -p <span class="variable">$(OUTPUTDIR)</span></span><br><span class="line">	cp -f GobiNet.ko <span class="variable">$(OUTPUTDIR)</span></span><br><span class="line">	depmod</span><br><span class="line">	modprobe -r GobiNet</span><br><span class="line">	modprobe GobiNet</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="comment"># rm -rf Makefile # 这里这段代码去掉，否则执行make clean会把Makefile文件也删除了</span></span><br><span class="line">	rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions Module.* modules.order</span><br></pre></td></tr></table></figure><p>​ 如果为其他版本的系统，将文件夹对应修改为<code>uname -r</code>得到的名称即可。</p><h3 id="添加串口的ID"><a href="#添加串口的ID" class="headerlink" title="添加串口的ID"></a>添加串口的ID</h3><p>​ 打开内核源码文件 <code>/3.10.0-957.el7.x86_64/drivers/usb/serial/option.c</code>，在<code>/* Vendor and product IDs */</code>下增加宏定义：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Vendor and product IDs */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEIG_VENDOR_ID                          0x05C6 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEIG_PRODUCT_730                        0xF601 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEIG_VENDOR_ID_720						0x2dee </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEIG_PRODUCT_720						0x4d07 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEIG_PRODUCT_720_ECM					0x4d02</span></span><br></pre></td></tr></table></figure><p>​ 在<code>option_ids</code>结构体数组增加4G模块的<code>VID</code>和<code>PID</code>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_id</span> <span class="title">option_ids</span>[] = &#123;</span></span><br><span class="line">	&#123; USB_DEVICE(MEIG_VENDOR_ID,MEIG_PRODUCT_730) &#125;, </span><br><span class="line">	&#123; USB_DEVICE(MEIG_VENDOR_ID_720,MEIG_PRODUCT_720) &#125;, </span><br><span class="line">	&#123; USB_DEVICE(MEIG_VENDOR_ID_720,MEIG_PRODUCT_720_ECM) &#125;,</span><br></pre></td></tr></table></figure><h3 id="删除NDIS和ADB端口"><a href="#删除NDIS和ADB端口" class="headerlink" title="删除NDIS和ADB端口"></a>删除NDIS和ADB端口</h3><p>​ 使用<code>option</code>驱动，修改 <code>/3.10.0-957.el7.x86_64/driver/usb/serial/option.c</code>，在<code>option_probe</code>函数添加如下代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">option_probe</span><span class="params">(struct usb_serial *serial,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">const</span> struct usb_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_interface_descriptor</span> *<span class="title">iface_desc</span> =</span></span><br><span class="line"><span class="class">				&amp;<span class="title">serial</span>-&gt;<span class="title">interface</span>-&gt;<span class="title">cur_altsetting</span>-&gt;<span class="title">desc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_device_descriptor</span> *<span class="title">dev_desc</span> = &amp;<span class="title">serial</span>-&gt;<span class="title">dev</span>-&gt;<span class="title">descriptor</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">option_blacklist_info</span> *<span class="title">blacklist</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Never bind to the CD-Rom emulation interface	*/</span></span><br><span class="line">	<span class="keyword">if</span> (iface_desc-&gt;bInterfaceClass == <span class="number">0x08</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Don't bind reserved interfaces (like network ones) which often have</span></span><br><span class="line"><span class="comment">	 * the same class/subclass/protocol as the serial interfaces.  Look at</span></span><br><span class="line"><span class="comment">	 * the Windows driver .INF files for reserved interface numbers.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	blacklist = (<span class="keyword">void</span> *)id-&gt;driver_info;</span><br><span class="line">	<span class="keyword">if</span> (blacklist &amp;&amp; test_bit(iface_desc-&gt;bInterfaceNumber,</span><br><span class="line">						&amp;blacklist-&gt;reserved))</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// struct usb_wwan_intf_private *data; 文档中的这个语句其实没有</span></span><br><span class="line">	<span class="comment">// 开始添加代码</span></span><br><span class="line">	<span class="keyword">if</span> (serial-&gt;dev-&gt;descriptor.idVendor == MEIG_VENDOR_ID &amp;&amp; </span><br><span class="line">		(serial-&gt;dev-&gt;descriptor.idProduct == MEIG_PRODUCT_730)&amp;&amp; </span><br><span class="line">		serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= <span class="number">4</span>) </span><br><span class="line">			<span class="keyword">return</span> -ENODEV; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (serial-&gt;dev-&gt;descriptor.idVendor == MEIG_VENDOR_ID_720&amp;&amp; </span><br><span class="line">		(serial-&gt;dev-&gt;descriptor.idProduct == MEIG_PRODUCT_720)&amp;&amp; </span><br><span class="line">		serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= <span class="number">4</span>) </span><br><span class="line">			<span class="keyword">return</span> -ENODEV; </span><br><span class="line">	<span class="comment">// 完成添加代码</span></span><br></pre></td></tr></table></figure><p>使用<code>usb-serial</code>驱动，<code>/3.10.0-957.el7.x86_64/driver/usb/serial/usb-serial.c</code>，在<code>usb_serial_probe</code>函数添加如下代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    serial = create_serial (dev, interface, type); </span><br><span class="line">   <span class="keyword">if</span> (!serial) &#123; </span><br><span class="line">           unlock_kernel(); </span><br><span class="line">           dev_err(&amp;interface-&gt;dev, <span class="string">"%s - out of memory\n"</span>, __FUNCTION__); </span><br><span class="line">           <span class="keyword">return</span> -ENOMEM; </span><br><span class="line">   &#125; </span><br><span class="line"><span class="comment">//开始添加代码 厂家文档写的是宏定义，在该文件中无法找到会报错，这里直接改成了对应值</span></span><br><span class="line">   <span class="keyword">if</span> ( (serial-&gt;dev-&gt;descriptor.idVendor == <span class="number">0x50C6</span> &amp;&amp;  </span><br><span class="line">		(serial-&gt;dev-&gt;descriptor.idProduct == <span class="number">0xF601</span>) )&amp;&amp; </span><br><span class="line">	serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;=<span class="number">4</span> ) </span><br><span class="line">		<span class="keyword">return</span> -ENOMEM; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (serial-&gt;dev-&gt;descriptor.idVendor == <span class="number">0x2dee</span> &amp;&amp; </span><br><span class="line">	(serial-&gt;dev-&gt;descriptor.idProduct == <span class="number">0x4d07</span>)&amp;&amp; </span><br><span class="line">	serial-&gt;interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber &gt;= <span class="number">4</span>) </span><br><span class="line">		<span class="keyword">return</span> -ENODEV; </span><br><span class="line"><span class="comment">//完成添加代码</span></span><br></pre></td></tr></table></figure><pre><code>### 配置编译参数</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/src/kernels/3.10.0-957.el7.x86_64  <span class="comment"># 切换到内核源码所在路径</span></span><br><span class="line">$ cp /boot/config-3.10.0-957.el7.x86_64 ./.config <span class="comment"># 拷贝当前内核的编译配置</span></span><br><span class="line">$ make oldconfig <span class="comment"># 在已有内核基础上进行配置</span></span><br><span class="line">$ yum install gcc gdb make elfutils-libelf-devel</span><br></pre></td></tr></table></figure><p>​ 需要说明的是，Centos 6.7默认就开启了<code>device drivers-&gt;usb support-&gt;usb serial converter support-&gt;USB driver for GSM and CDMA modems</code>和<code>device drivers-&gt;Network device support-&gt;usb Network Adapters-&gt;Multi-purpose USB Networking Framework</code>这两个组件，所以拷贝原有内核的编译配置即可使用。</p><h3 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h3><p>​ 执行如下命令开始编译源码，对应的线程数字按照实际机器进行配置，这个过程会比较慢。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make -j 8</span><br></pre></td></tr></table></figure><p>​ 如果有其他错误提示，则安装对应的软件包依赖即可，这里编译后不进行安装，因为内核是一样的，编译内核只是为了编译驱动时能找到一些依赖。</p><h2 id="编译NDIS驱动"><a href="#编译NDIS驱动" class="headerlink" title="编译NDIS驱动"></a>编译NDIS驱动</h2><p>​ 这里采用的是单独编译的方式，所以上一个步骤没有和内核一块打包编译，主要是为了在不动原来内核的情况下使用，以防上面的其他软件运行受影响。</p><p>​ 到驱动目录下，执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make <span class="comment"># 编译驱动</span></span><br><span class="line">$ make install <span class="comment"># 安装驱动</span></span><br></pre></td></tr></table></figure><p>​ 正常编译安装的话，不会有其他的警告或者错误，驱动成功后，可以看到新的网卡。一般是<code>ethX</code>这种格式，但还没有IP地址，需要使用拨号软件。</p><h2 id="编译Gobinet拨号工具"><a href="#编译Gobinet拨号工具" class="headerlink" title="编译Gobinet拨号工具"></a>编译Gobinet拨号工具</h2><p>​ 在厂家提供的源码中，由于是嵌入式的方案，默认获取IP地址的是<code>busybox</code>中的<code>udhcpc</code>命令，在<code>udhcpc.c</code>文件中，可以注释掉这样代码，以及这行代码上面两行的寻找默认配置文件的语句。本文管理网卡的工具是<code>NetworkManager</code>，Gobinet拨号后，会自动检测网卡状态，进行获取IP地址操作。其它系统根据实际需要，进行修改。本文做出的修改如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (profile-&gt;ipv4.Address) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_DHCLIENT</span></span><br><span class="line">            <span class="built_in">snprintf</span>(udhcpc_cmd, <span class="keyword">sizeof</span>(udhcpc_cmd), <span class="string">"dhclient -4 -d --no-pid %s"</span>, ifname);</span><br><span class="line">            dhclient_alive++;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    		<span class="comment">// 注释掉获取默认配置文件</span></span><br><span class="line">            <span class="comment">//if (access("/usr/share/udhcpc/default.script", X_OK)) &#123;</span></span><br><span class="line">            <span class="comment">//    dbg_time("Fail to access /usr/share/udhcpc/default.script, errno: %d (%s)", errno, strerror(errno));</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//-f,--foreground    Run in foreground</span></span><br><span class="line">            <span class="comment">//-b,--background    Background if lease is not obtained</span></span><br><span class="line">            <span class="comment">//-n,--now        Exit if lease is not obtained</span></span><br><span class="line">            <span class="comment">//-q,--quit        Exit after obtaining lease</span></span><br><span class="line">            <span class="comment">//-t,--retries N        Send up to N discover packets (default 3)</span></span><br><span class="line">    		<span class="comment">// 注释定义的获取IP命令</span></span><br><span class="line">            <span class="comment">//snprintf(udhcpc_cmd, sizeof(udhcpc_cmd), "busybox udhcpc -f -n -q -t 5 -i %s", ifname);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="comment">// 注释掉命令线程</span></span><br><span class="line">            <span class="comment">//pthread_create(&amp;udhcpc_thread_id, &amp;udhcpc_thread_attr, udhcpc_thread_function, (void*)strdup(udhcpc_cmd));</span></span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>​ 执行如下命令编译拨号工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make <span class="comment"># 编译</span></span><br><span class="line">$ ./MeiG-CM &amp; <span class="comment"># 后台执行拨号工具</span></span><br></pre></td></tr></table></figure><p>​ 如果拨号成功，可以看到对应的网卡会获取到IP地址，并可以正常上网。</p><h2 id="服务化拨号工具"><a href="#服务化拨号工具" class="headerlink" title="服务化拨号工具"></a>服务化拨号工具</h2><p>​ 可以使用<code>systemctl</code>管理拨号工具，新建一个文件<code>MeiG-CM.service</code>，并写入如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=quectel-CM Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">ExecStart=/home/MeiG-CM/MeiG-CM <span class="comment"># 这里更改为对应的可执行文件所在路径</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>​ 执行以下命令可配置服务并设置开机自启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cp MeiG-CM.service /usr/lib/systemd/system/ <span class="comment"># 拷贝服务文件到系统目录</span></span><br><span class="line">$ systemctl daemon-reload <span class="comment"># 重新检测加载服务，使其被系统识别到</span></span><br><span class="line">$ systemctl start MeiG-CM.service <span class="comment"># 手动启动服务</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> MeiG-CM.service <span class="comment"># 配置开机自启动</span></span><br></pre></td></tr></table></figure><p>​ 至此，在Centos 7.6上就可以自动配置MeiG SLM50 4G模块上网。如果卡被停用后·再启用，也不需要重新启动机器，会自动重新拨号。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Alderaan</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://alderaan.xyz/2020/05/11/centos7-6-use-meig-4G-module-slm750/" title="Centos 7.6 下使用美格SLM750（4G模块）拨号上网">https://alderaan.xyz/2020/05/11/centos7-6-use-meig-4G-module-slm750/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Centos/" rel="tag"><i class="fa fa-tag"></i> Centos</a><a href="/tags/4G-moduleC/" rel="tag"><i class="fa fa-tag"></i> 4G moduleC</a><a href="/tags/SLM750/" rel="tag"><i class="fa fa-tag"></i> SLM750</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/05/10/mw150us-2-0-mac-driver/" rel="prev" title="水星USB无线网卡mw150us苹果macOS系统驱动成功"><i class="fa fa-chevron-left"></i> 水星USB无线网卡mw150us苹果macOS系统驱动成功</a></div><div class="post-nav-item"></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译内核源码"><span class="nav-number">3.</span> <span class="nav-text">编译内核源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加串口的ID"><span class="nav-number">3.1.</span> <span class="nav-text">添加串口的ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除NDIS和ADB端口"><span class="nav-number">3.2.</span> <span class="nav-text">删除NDIS和ADB端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开始编译"><span class="nav-number">3.3.</span> <span class="nav-text">开始编译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译NDIS驱动"><span class="nav-number">4.</span> <span class="nav-text">编译NDIS驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译Gobinet拨号工具"><span class="nav-number">5.</span> <span class="nav-text">编译Gobinet拨号工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务化拨号工具"><span class="nav-number">6.</span> <span class="nav-text">服务化拨号工具</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Alderaan" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">Alderaan</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Alderaan</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script></body></html>